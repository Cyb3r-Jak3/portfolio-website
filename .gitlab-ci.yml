stages:
  - test
  - deploy_self
  - dast
  - deploy_firebase
  - clear

include:
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml

html_test:
  stage: test
  image: cyb3rjak3/html5validator:latest
  script:
    - date=`date +"%d %B %Y (%T %Z)"`
    - sed -i "/BUILD_DATE/{s//$date/g}"  public/index.html
    - head public/index.html -n 11 | grep Built
    - html5validator --root public/ --also-check-css --log INFO --format json --ignore-re Attribute "built" Element "meta"
  artifacts:
   paths:
     - public/*
   expire_in: 1 week

Self_Host_Deploy:
  stage: deploy_self
  image: cyb3rjak3/docker-curl-ssh
  before_script:
  - eval $(ssh-agent -s)
  - echo "$SSH_P_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - cat $SSH_KNOWN > ~/.ssh/known_hosts
  script:
  - scp -rp -P 2222 public/*  $DeployUser@$ServerIP:$RPath
  environment:
    name: Self_Host
    url: https://portfolio.jwhite.network

dast:
  stage: dast
  dependencies: []
  variables: 
    DAST_WEBSITE: https://portfolio.jwhite.network
    DAST_FULL_SCAN_ENABLED: "true"
    DAST_REQUEST_HEADERS: "User-Agent: DAST/1.0"
          

Firebase_Deploy:
  stage: deploy_firebase
  image: devillex/docker-firebase
  before_script:
    - npm i -g firebase-tools 
  script:
    - firebase use --token $FIREBASE_TOKEN personal-website-e2713
    - firebase deploy -m "Commit $CI_COMMIT_TITLE, Pipeline $CI_PIPELINE_ID, build $CI_BUILD_ID" --non-interactive --token $FIREBASE_TOKEN
  environment:
    name: Public
    url: https://www.jwhite.network
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - changes:
      - public/*

Clear_Cache:
  stage: clear
  image: cyb3rjak3/docker-curl-ssh
  needs:
  - Firebase_Deploy
  script:
    - >
      curl -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE/purge_cache" -H "$API_KEY" -H "Content-Type: application/json"  --data '{"files":["https://www.jwhite.network/*", "https://portfolio.jwhite.network/*"]}'